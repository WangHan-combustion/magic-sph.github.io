<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Numerical technique &mdash; Magic 5.1 documentation</title>
    
    <link rel="stylesheet" href="_static/magic.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '5.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="shortcut icon" href="_static/favicon.ico"/>
    <link rel="top" title="Magic 5.1 documentation" href="contents.html" />
    <link rel="next" title="Contributing to the code" href="contribute.html" />
    <link rel="prev" title="Formulation of the (magneto)-hydrodynamics problem" href="equations.html" />
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:300,400,700'
          rel='stylesheet' type='text/css' />
    <script src="galleria/galleria-1.4.2.min.js"></script>
 
    <style type="text/css">
      table.right { float: right; margin-left: 20px; }
      table.right td { border: 1px solid #ccc; }
      
  </style>
  <script type="text/javascript">
      // intelligent scrolling of the sidebar content
      $(window).scroll(function() {
        var sb = $('.sphinxsidebarwrapper');
        var win = $(window);
        var sbh = sb.height();
        var offset = $('.sphinxsidebar').position()['top'];
        var wintop = win.scrollTop();
        var winbot = wintop + win.innerHeight();
        var curtop = sb.position()['top'];
        var curbot = curtop + sbh;
        // does sidebar fit in window?
        if (sbh < win.innerHeight()) {
          // yes: easy case -- always keep at the top
          sb.css('top', $u.min([$u.max([0, wintop - offset - 10]),
                                $(document).height() - sbh - 200]));
        } else {
          // no: only scroll if top/bottom edge of sidebar is at
          // top/bottom edge of window
          if (curtop > wintop && curbot > winbot) {
            sb.css('top', $u.max([wintop - offset - 10, 0]));
          } else if (curtop < wintop && curbot < winbot) {
            sb.css('top', $u.min([winbot - sbh - offset - 20,
                                  $(document).height() - sbh - 200]));
          }
        }
      });
    </script>

  </head>
  <body role="document">
<div class="pageheader">
  <ul>
    <li><a href="index.html">Home</a></li>
    <li><a href="install.html">Get it/Run it</a></li>
    <li><a href="contribute.html">Contribute!</a></li>
    <li><a href="#">Numerical methods</a></li>
    <li><a href="contents.html">Contents</a></li>
  </ul>
  <div>
    <a href="index.html">
      <img src="_static/logo.png" alt="magic" height="120px" width="192px"/>
    </a>
  </div>
</div>

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="f-modindex.html" title="Fortran Module Index"
             >fortran modules</a> |</li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="contribute.html" title="Contributing to the code"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="equations.html" title="Formulation of the (magneto)-hydrodynamics problem"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="contents.html">Magic 5.1 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="numerical-technique">
<span id="secnumerics"></span><h1>Numerical technique<a class="headerlink" href="#numerical-technique" title="Permalink to this headline">¶</a></h1>
<p>MagIC is a pseudo-spectral MHD code. This numerical technique was originally
developed by P. Gilman and G. Glatzmaier for the spherical geometry.  In this
approach the unknowns are expanded into complete sets of functions in radial
and angular directions: Chebyshev polynomials in the radial directions and
spherical harmonic functions in the azimuthal and latitudinal directions.  This
allows to express all partial derivatives analytically.  Employing
orthogonality relations of spherical harmonic functions and using collocation
in radius then lead to algebraic equations that are integrated in time with a
mixed implicit/explicit time stepping scheme.  The nonlinear terms and the
Coriolis force are evaluated in the physical (or grid) space rather than in
spectral space.  Although this approach requires costly numerical
transformations between the two representations (from spatial to spectral using
Legendre and Fourier transforms), the resulting decoupling of all spherical
harmonic modes leads to a net gain in computational speed.  Before explaining
these methods in more detail, we introduce the poloidal/toroidal decomposition.</p>
<div class="section" id="poloidal-toroidal-decomposition">
<h2>Poloidal/toroidal decomposition<a class="headerlink" href="#poloidal-toroidal-decomposition" title="Permalink to this headline">¶</a></h2>
<p>Any vector <span class="math">\(\vec{v}\)</span> that fulfills  <span class="math">\(\vec{\nabla}\cdot\vec{v}=0\)</span>
can be decomposed in a poloidal and toroidal part <span class="math">\(W\)</span> and <span class="math">\(Z\)</span>,
respectively</p>
<div class="math">
\[\vec{v} = \vec{\nabla}\times\left(\vec{\nabla}\times W\,\vec{e_r}\right) +
\vec{\nabla}\times Z\,\vec{e_r}.\]</div>
<p>Three unknown vector components are thus replaced by two scalar fields,
the poloidal potential <span class="math">\(W\)</span> and the toroidal potential <span class="math">\(Z\)</span>.
This decomposition is unique, aside from an arbitrary radial function  <span class="math">\(f(r)\)</span>
that can be added to <span class="math">\(W\)</span> or <span class="math">\(Z\)</span> without affecting <span class="math">\(\vec{v}\)</span>.</p>
<p>In the anelastic approximation, such a decomposition can be used for the
mass flux <span class="math">\(\tilde{\rho}\vec{u}\)</span> and the magnetic field <span class="math">\(\vec{B}\)</span>. This yields</p>
<div class="math" id="equation-eqToroPolo">
<span class="eqno">(1)</span>\[\begin{split}\begin{aligned}
\tilde{\rho} \vec{u} &amp; = \vec{\nabla}\times(\vec{\nabla}\times W\,\vec{e_r}) +
\vec{\nabla}\times Z\,\vec{e_r} \\
\vec{B} &amp; = \vec{\nabla}\times(\vec{\nabla}\times g\,\vec{e_r}) +
\vec{\nabla}\times h\,\vec{e_r}.
\end{aligned}\end{split}\]</div>
<p>The two scalar potentials of a divergence free vector field can be extracted
from its radial component and the radial component of its curl:</p>
<div class="math" id="equation-eqDeltaH">
<span class="eqno">(2)</span>\[\begin{split}\begin{aligned}
\vec{e_r}\cdot \vec{v} &amp;=  - \Delta_H W, \\
\vec{e_r}\cdot\left(\vec{\nabla}\times\vec{B}\right) &amp; = - \Delta_H Z,
\end{aligned}\end{split}\]</div>
<p>where the operator <span class="math">\(\Delta_H\)</span> denotes the horizontal part of the Laplacian:</p>
<div class="math" id="equation-eqLaplaceH">
<span class="eqno">(3)</span>\[\Delta_H= \frac{1}{r^{2}\sin{\theta}}
\frac{\partial}{\partial\theta}\left(\sin{\theta}\frac{\partial}{\partial\theta}\right)
+ \frac{1}{r^{2}\sin^2{\theta}} \frac{\partial^{2}}{\partial^{2}\phi}.\]</div>
</div>
<div class="section" id="spherical-harmonic-representation">
<h2>Spherical harmonic representation<a class="headerlink" href="#spherical-harmonic-representation" title="Permalink to this headline">¶</a></h2>
<p>Spherical harmonic functions <span class="math">\(Y_\ell^m\)</span> are a natural choice for the
horizontal expansion in colatitude <span class="math">\(\theta\)</span> and longitude <span class="math">\(\phi\)</span>:</p>
<div class="math">
\[Y_\ell^m(\theta,\phi) = P_{\ell}^m(\cos{\theta})\,e^{i m \phi},\]</div>
<p>where <span class="math">\(\ell\)</span> and <span class="math">\(m\)</span> denote spherical harmonic degree and order, respectively,
<span class="math">\(P_\ell^m\)</span> is an associated Legendre function.  Different normalization are in
use. Here we adopt a complete normalization so that the orthogonality relation
reads</p>
<div class="math" id="equation-eqOrthoYlm">
<span class="eqno">(4)</span>\[\int_{0}^{2\pi} d\,\phi \int_{0}^{\pi}
\sin{\theta}\, d\theta\; Y_\ell^m(\theta,\phi)\,Y_{\ell^\prime}^{m^\prime}
(\theta,\phi) \; =  \; \delta_{\ell \ell^\prime}\delta^{m m^\prime}.\]</div>
<p>This means that</p>
<div class="math">
\[Y_{\ell}^{m}(\theta,\phi) = \sqrt{\dfrac{1}{2\pi}}\dfrac{(2\ell+1)(\ell-|m|)!}{2(\ell+|m|)!}
P_\ell^m(\cos{\theta})\,e^{i m \phi}\,(-1)^m,\]</div>
<p>For example, the spherical harmonic representation of the
magnetic poloidal potential <span class="math">\(g(r,\theta,\phi)\)</span>, truncated at degree and order
<span class="math">\(\ell_{max}\)</span>, then reads</p>
<div class="math" id="equation-eqSpatSpec">
<span class="eqno">(5)</span>\[g(r,\theta,\phi) = \sum_{\ell=0}^{\ell_{max}}\sum_{m=-\ell}^{\ell} g_{\ell m}(r)\,Y_{\ell}^{m}(\theta,\phi),\]</div>
<p>with</p>
<div class="math" id="equation-eqLegTF1">
<span class="eqno">(6)</span>\[g_{\ell m}(r) = \frac{1}{\pi}\,\int_{0}^{\pi} d \theta \sin{\theta}\; g_m(r,\theta)\;
P_\ell^m(\cos{\theta}),\]</div>
<div class="math" id="equation-eqLegTF2">
<span class="eqno">(7)</span>\[g_{m}(r,\theta) = \frac{1}{2\pi}\,\int_{0}^{2\pi} d \phi\; g(r,\theta,\phi)\; e^{- i m \phi} .\]</div>
<p>The potential <span class="math">\(g(r,\theta,\phi)\)</span> is a real function so that
<span class="math">\(g_{\ell m}^\star(r)=g_{\ell,-m}(r)\)</span>, where the asterisk denotes the complex conjugate.
Thus, only coefficients with <span class="math">\(m \ge 0\)</span> have to be considered. The same kind of
expansion is made for the toroidal magnetic potential, the mass flux potentials,
pressure and entropy (or temperature).</p>
<p>The equations <a href="#equation-eqLegTF1">(6)</a> and <a href="#equation-eqLegTF2">(7)</a> define a two-step transform
from the longitude/latitude representation to the spherical harmonic
representation <span class="math">\((r,\theta,\phi)\longrightarrow(r,\ell,m)\)</span>.  The equation
<a href="#equation-eqSpatSpec">(5)</a> formulates the inverse procedure
<span class="math">\((r,\ell,m)\longrightarrow(r,\theta,\phi)\)</span>. Fast-Fourier transforms are
employed in the longitudinal direction, requiring (at least) <span class="math">\(N_\phi = 2 \ell_{max}+1\)</span>
evenly spaced grid points <span class="math">\(\phi_i\)</span>.
MagIC relies on the Gauss-Legendre quadrature for evaluating the integral
<a href="#equation-eqLegTF1">(6)</a></p>
<div class="math">
\[g_{\ell m}(r) = \frac{1}{N_{\theta}}
\sum_{j=1}^{N_{\theta}}\,w_j\,g_m(r,\theta_j)\; P_\ell^m(\cos{\theta_j}),\]</div>
<p>where <span class="math">\(\theta_j\)</span> are the <span class="math">\(N_{\theta}\)</span> Gaussian quadrature points
defining the latitudinal grid, and <span class="math">\(w_j\)</span> are the respective weights.  Pre-stored
values of the associated Legendre functions at grid points <span class="math">\(\theta_j\)</span> in
combination with a FFT in <span class="math">\(\phi\)</span> provide the inverse transform <a href="#equation-eqSpatSpec">(5)</a>.
Generally, <span class="math">\(N_\phi=  2 N_\theta\)</span> is chosen, which provides
isotropic resolution in the equatorial region.  Choosing
<span class="math">\(\ell_{max}= [ \min(2 N_\theta,N_\phi)-1]/3\)</span> prevents aliasing errors.</p>
<div class="section" id="special-relations">
<h3>Special relations<a class="headerlink" href="#special-relations" title="Permalink to this headline">¶</a></h3>
<p>The action of a horizontal Laplacian <a href="#equation-eqLaplaceH">(3)</a> on spherical harmonics can be
analytically expressed by</p>
<div class="math" id="equation-eqHorizLaplYlm">
<span class="eqno">(8)</span>\[\Delta_H Y_{\ell}^{m} = -\dfrac{\ell(\ell+1)}{r^2}\,Y_{\ell}^{m}\,.\]</div>
<p>They are several useful recurrence relations for the Legendre polynomials that will
be further employed to compute Coriolis forces and the <span class="math">\(\theta\)</span> and <span class="math">\(\phi\)</span>
derivatives of advection and Lorentz forces:</p>
<div class="math" id="equation-eqCosPlm">
<span class="eqno">(9)</span>\[\cos\theta\,\partial P_\ell^m = c_{\ell+1}^m\,P_{\ell+1}^m
+c_{\ell}^m\,P_{\ell-1}^m\,,\]</div>
<p>and</p>
<div class="math" id="equation-eqSindPlm">
<span class="eqno">(10)</span>\[\sin\theta\,\dfrac{\partial P_\ell^m}{\partial \theta} = (\ell-1)\,c_{\ell+1}^m\,P_{\ell+1}^m
-(\ell+2)\,c_{\ell}^m\,P_{\ell-1}^m \,,\]</div>
<p>where <span class="math">\(c_\ell^m\)</span> is defined by</p>
<div class="math" id="equation-eqClmOp">
<span class="eqno">(11)</span>\[c_\ell^m = \sqrt{\dfrac{(\ell+m)(\ell-m)}{(2\ell-1)(2\ell+1)}}\,.\]</div>
</div>
</div>
<div class="section" id="radial-representation">
<h2>Radial representation<a class="headerlink" href="#radial-representation" title="Permalink to this headline">¶</a></h2>
<p>In MagIC, the radial dependencies are expanded into complete sets of functions: the
Chebyshev polynomials <span class="math">\({\cal C}(x)\)</span>.  The polynomial of degree <span class="math">\(n\)</span> is defined by</p>
<div class="math">
\[{\cal C}_n(x)=\cos\left[n\,\arccos(x)\right]\quad -1\leq x \leq 1\,.\]</div>
<p>When truncating at degree <span class="math">\(N\)</span>, the radial expansion of the poloidal
magnetic potential reads</p>
<div class="math" id="equation-eqGridCheb">
<span class="eqno">(12)</span>\[g_{\ell m}(r) = \sum_{n=0}^{N} g_{\ell mn}\;{\cal C}_n(r) ,\]</div>
<p>with</p>
<div class="math" id="equation-eqSpecCheb">
<span class="eqno">(13)</span>\[g_{\ell mn} = \frac{2-\delta_{n0}}{\pi}\int_{-1}^{1}
 \frac{d x\, g_{\ell m}(r(x))\;{\cal C}_n(x)}{\sqrt{1-x^2}} .\]</div>
<p>The Chebyshev definition space <span class="math">\((-1\leq x\leq 1)\)</span> is then linearly mapped
onto a radius range <span class="math">\((r_i\leq r \leq r_o)\)</span> by</p>
<div class="math" id="equation-eqChebMap">
<span class="eqno">(14)</span>\[x(r)=  2 \frac{r-r_i}{r_o-r_i} - 1 .\]</div>
<p>In addition, nonlinear mapping can be defined to modify the radial dependence of the
grid-point density.</p>
<p>When choosing the <span class="math">\(N_r\)</span> extrema of <span class="math">\({\cal C}_{N_r-1}\)</span>  as radial grid points,</p>
<div class="math" id="equation-eqChebGrid">
<span class="eqno">(15)</span>\[x_k=\cos{\left(\pi \frac{(k-1)}{N_r-1}\right)}\;\;\;,\;\;\; k=1,2,\ldots,N_r ,\]</div>
<p>the values of the Chebyshev polynomials at these points are simply given by
the cosine functions:</p>
<div class="math">
\[{\cal C}_{nk} = {\cal C}_n(x_k)=\cos{\left(\pi \frac{ n (k-1)}{N_r-1}\right)} .\]</div>
<p>This particular choice has two advantages.
For one, the grid points become denser toward the inner and outer
radius and better resolve potential thermal and viscous boundary layers.
In addition, FFTs can be employed to switch between
grid representation <a href="#equation-eqGridCheb">(12)</a> and Chebyshev representations <a href="#equation-eqSpecCheb">(13)</a>,
rendering this procedure a fast-Chebyshev transform.
Choosing <span class="math">\(N_r&gt;N\)</span> provides radial dealiasing.</p>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<p class="last">The Chebyshev (Gauss-Lobatto) grid is defined in the module
<a class="reference internal" href="apiFortran/legFourierChebAlgebra.html#f/chebyshev_polynoms_mod" title="f/chebyshev_polynoms_mod"><code class="xref f f-mod docutils literal"><span class="pre">chebyshev_polynoms_mod</span></code></a>. The cosine transforms are computed in the
modules <a class="reference internal" href="apiFortran/legFourierChebAlgebra.html#f/cosine_transform" title="f/cosine_transform"><code class="xref f f-mod docutils literal"><span class="pre">cosine_transform</span></code></a> and <a class="reference internal" href="apiFortran/legFourierChebAlgebra.html#f/fft_fac_mod" title="f/fft_fac_mod"><code class="xref f f-mod docutils literal"><span class="pre">fft_fac_mod</span></code></a>.</p>
</div>
</div>
<div class="section" id="spectral-equations">
<h2>Spectral equations<a class="headerlink" href="#spectral-equations" title="Permalink to this headline">¶</a></h2>
<p>We have now introduced the necessary tools for deriving the
spectral equations.
Taking the <strong>radial components</strong> of the Navier-Stokes equation
and the induction equation provides the equations
for the poloidal potentials <span class="math">\(W(r,\theta,\phi)\)</span> and <span class="math">\(g(r,\theta,\phi)\)</span>.
The <strong>radial component of the curl</strong> of these equations provides
the equations for the toroidal counterparts
<span class="math">\(Z(r,\theta,\phi)\)</span> and <span class="math">\(h(r,\theta,\phi)\)</span>.
The pressure remains an additional unknown. Hence one more equation
involving <span class="math">\(W_{\ell mn}\)</span> and <span class="math">\(p_{\ell mn}\)</span>
is required. It is obtained by taking the
<strong>horizontal divergence</strong> of the Navier-Stokes equation.</p>
<p>Expanding all potentials in spherical harmonics and Chebyshev polynomials,
multiplying with <span class="math">\({Y_{\ell}^{m}}^\star\)</span>, and integrating over spherical surfaces
(while making use of
the orthogonality relation <a href="#equation-eqOrthoYlm">(4)</a> results in equations for the
coefficients <span class="math">\(W_{\ell mn}\)</span>, <span class="math">\(Z_{\ell mn}\)</span>, <span class="math">\(g_{\ell mn}\)</span>,
<span class="math">\(h_{\ell mn}\)</span>, <span class="math">\(P_{\ell mn}\)</span> and <span class="math">\(s_{\ell mn}\)</span>,
respectively.</p>
<div class="section" id="equation-for-the-poloidal-potential">
<h3>Equation for the poloidal potential <span class="math">\(W\)</span><a class="headerlink" href="#equation-for-the-poloidal-potential" title="Permalink to this headline">¶</a></h3>
<p>The temporal evolution of <span class="math">\(W\)</span> is obtained by taking <span class="math">\(\vec{e_r}\cdot\)</span> of each
term entering the Navier-Stokes equation. For the
time-derivative, one gets using <a href="#equation-eqDeltaH">(2)</a>:</p>
<div class="math">
\[\tilde{\rho}\vec{e_r}\cdot\left(\dfrac{\partial \vec{u}}{\partial t}\right) =
\dfrac{\partial}{\partial t}(\vec{e_r}\cdot\tilde{\rho}\vec{u})=-\Delta_H\dfrac{\partial
W}{\partial t}.\]</div>
<p>For the viscosity term, one gets</p>
<div class="math">
\[\begin{split}\begin{aligned}
\vec{e_r}\cdot\vec{\nabla}\cdot \mathsf{S} = &amp; -\nu\,\Delta_H\left[\dfrac{\partial^2 W}
{\partial r^2}
+\left\lbrace 2\dfrac{d\ln\nu}{dr}-\dfrac{1}{3}\dfrac{d\ln\tilde{\rho}}{dr}\right\rbrace
\dfrac{\partial W}{\partial r} \right. \\
&amp; -\left. \left\lbrace -\Delta_H + \dfrac{4}{3}\left(\dfrac{d^2\ln\tilde{\rho}}{dr^2}
+\dfrac{d\ln\nu}{dr} \dfrac{d\ln\tilde{\rho}}{dr}  +
\dfrac{1}{r}\left[3\dfrac{d\ln\nu}{dr}+
\dfrac{d\ln\tilde{\rho}}{dr}\right] \right) \right\rbrace W\right],
\end{aligned}\end{split}\]</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>In case of a constant kinematic viscosity, the <span class="math">\(d\ln\nu/dr\)</span>
terms vanish. If in addition,the background density is constant, the
<span class="math">\(d\ln\tilde{\rho}/dr\)</span> terms also vanish. In that Boussinesq limit, this
viscosity term would then be simplified as</p>
<div class="last math">
\[\vec{e_r}\cdot\Delta \vec{u} = -\Delta_H\left[\dfrac{\partial^2 W}{\partial r^2}
+\Delta_H\,W\right]\]</div>
</div>
<p>Using Eq. <a href="#equation-eqHorizLaplYlm">(8)</a> then allows to finally write the time-evolution equation
for the poloidal potential <span class="math">\(W_{\ell m n}\)</span>:</p>
<div class="math" id="equation-eqSpecW">
<span class="eqno">(16)</span>\[\begin{split}\boxed{
\begin{aligned}
E\,\dfrac{\ell(\ell+1)}{r^2}\left[\left\lbrace\dfrac{\partial}{\partial t} +
\nu\,\dfrac{\ell(\ell+1)}{r^2} + \dfrac{4}{3}\,\nu\,\left(\dfrac{d^2\ln\tilde{\rho}}{dr^2}
+\dfrac{d\ln\nu}{dr} \dfrac{d\ln\tilde{\rho}}{dr}  +
\dfrac{1}{r}\left[3\dfrac{d\ln\nu}{dr}+
\dfrac{d\ln\tilde{\rho}}{dr}\right] \right)\right\rbrace\right. &amp; \,{\cal C}_n  &amp; \\
-\nu\,\left\lbrace 2\dfrac{d\ln\nu}{dr}-\dfrac{1}{3}\dfrac{d\ln\tilde{\rho}}{dr}\right\rbrace
&amp;\,{\cal C}'_n &amp; \\
-\nu &amp; \,{\cal C}''_n \left. \phantom{\dfrac{d\nu}{dr}}\right]&amp; W_{\ell m n} \\
+ \left[{\cal C}'_n -\dfrac{d\ln\tilde{\rho}}{dr}{\cal C}_n\right] &amp; &amp; P_{\ell m n} \\
- \left[\dfrac{Ra\,E}{Pr}\,\tilde{\rho}\,g(r)\right] &amp; \,{\cal C}_n &amp; s_{\ell m n} \\
= {\cal N}^W = \int d\Omega\,{Y_{\ell}^{m}}^\star\,\vec{e_r}\cdot \vec{F} &amp; &amp;
\end{aligned}}\end{split}\]</div>
<p>Here, <span class="math">\(d\Omega\)</span> is the spherical surface element. We use the summation convention
for the Chebyshev index <span class="math">\(n\)</span>. The radial derivatives of Chebyshev
polynomials are denoted by primes.</p>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<p class="last">The exact computation of the linear terms of <a href="#equation-eqSpecW">(16)</a> are coded in
the subroutines <a class="reference internal" href="apiFortran/timeAdvLinear.html#f/updatewp_mod/get_wpmat" title="f/updatewp_mod/get_wpmat"><code class="xref f f-subr docutils literal"><span class="pre">get_wpMat</span></code></a></p>
</div>
</div>
<div class="section" id="equation-for-the-toroidal-potential">
<h3>Equation for the toroidal potential <span class="math">\(Z\)</span><a class="headerlink" href="#equation-for-the-toroidal-potential" title="Permalink to this headline">¶</a></h3>
<p>The temporal evolution of <span class="math">\(Z\)</span> is obtained by taking the radial component of the
curl of the Navier-Stokes equation (i.e.  <span class="math">\(\vec{e_r}\cdot\vec{\nabla}\times\)</span>). For
the time derivative, one gets using <a href="#equation-eqDeltaH">(2)</a>:</p>
<div class="math">
\[\vec{e_r}\cdot\vec\nabla\times\left(\dfrac{\partial\tilde{\rho}\vec{u}}{\partial t}\right)=
\dfrac{\partial}{\partial t}(\vec{e_r}\cdot\vec{\nabla}\times\tilde{\rho}
\vec{u})=-\dfrac{\partial}{\partial t}(\Delta_H Z) = -\Delta_H\dfrac{\partial Z}{\partial t}\]</div>
<p>The pressure gradient, one has</p>
<div class="math">
\[\vec{\nabla}\times \left[\tilde{\rho}\vec{\nabla}\left(\dfrac{p'}{\tilde{\rho}}\right)\right] =
\vec{\nabla} \tilde{\rho} \times \vec{\nabla}\left(\dfrac{p'}{\tilde{\rho}}\right) +
\underbrace{\tilde{\rho} \vec{\nabla} \times \left[\vec{\nabla}\left( \dfrac{p'}{\tilde{\rho}}
\right)\right]}_{=0}.\]</div>
<p>This expression has no component along <span class="math">\(\vec{e_r}\)</span>, as a consequence, there is
no pressure gradient contribution here. The
gravity term also vanishes as <span class="math">\(\vec{\nabla}\times(\tilde{\rho}g(r)\vec{e_r})\)</span> has no
radial component.</p>
<div class="math">
\[\begin{split}\begin{aligned}
\vec{e_r}\cdot\vec{\nabla}\times\left[\vec{\nabla}\cdot\mathsf{S}\right] = &amp;
-\nu\,\Delta_H\left[\dfrac{\partial^2 Z}{\partial r^2}
+\left(\dfrac{d\ln\nu}{dr}-\dfrac{d\ln\tilde{\rho}}{dr}\right)\,\dfrac{\partial Z}{\partial r}  \right.\\
&amp; \left. - \left(\dfrac{d\ln\nu}{dr}\dfrac{d\ln\tilde{\rho}}{dr}+
  \dfrac{2}{r}\dfrac{d\ln\nu}{dr}+
  \dfrac{d^2\ln\tilde{\rho}}{dr^2}+\dfrac{2}{r}
\dfrac{d\ln\tilde{\rho}}{dr}-\Delta_H\right) Z \right].
\end{aligned}\end{split}\]</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>Once again, this viscous term can be greatly simplified in the Boussinesq limit:</p>
<div class="last math">
\[\vec{e_r}\cdot\vec{\nabla}\times\left(\Delta \vec{u}\right) =
-\Delta_H\left[\dfrac{\partial^2 Z}{\partial r^2}
+\Delta_H\,Z\right]\]</div>
</div>
<p>Using Eq. <a href="#equation-eqHorizLaplYlm">(8)</a> then allows to finally write the time-evolution equation
for the poloidal potential <span class="math">\(Z_{\ell m n}\)</span>:</p>
<div class="math" id="equation-eqSpecZ">
<span class="eqno">(17)</span>\[\begin{split}\boxed{
\begin{aligned}
E\,\dfrac{\ell(\ell+1)}{r^2}\left[\left\lbrace\dfrac{\partial}{\partial t} +
\nu\,\dfrac{\ell(\ell+1)}{r^2} + \nu\,\left(\dfrac{d\ln\nu}{dr}\dfrac{d\ln\tilde{\rho}}{dr}+
\dfrac{2}{r}\dfrac{d\ln\nu}{dr}+ \dfrac{d^2\ln\tilde{\rho}}{dr^2}+\dfrac{2}{r}
\dfrac{d\ln\tilde{\rho}}{dr}\right)\right\rbrace\right. &amp; \,{\cal C}_n  &amp; \\
-\nu\,\left(\dfrac{d\ln\nu}{dr}-\dfrac{d\ln\tilde{\rho}}{dr}\right) &amp;\,{\cal C}'_n &amp; \\
-\nu &amp; \,{\cal C}''_n \left. \phantom{\dfrac{d\nu}{dr}}\right]&amp; Z_{\ell m n} \\
= {\cal N}^Z = \int d\Omega\,{Y_{\ell}^{m}}^\star\,\vec{e_r}\cdot \left(\vec{\nabla}\times\vec{F}\right) &amp; &amp;
\end{aligned}}\end{split}\]</div>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<p class="last">The exact computation of the linear terms of <a href="#equation-eqSpecZ">(17)</a> are coded in
the subroutines <a class="reference internal" href="apiFortran/timeAdvLinear.html#f/updatez_mod/get_zmat" title="f/updatez_mod/get_zmat"><code class="xref f f-subr docutils literal"><span class="pre">get_zMat</span></code></a></p>
</div>
</div>
<div class="section" id="equation-for-pressure">
<h3>Equation for pressure <span class="math">\(P\)</span><a class="headerlink" href="#equation-for-pressure" title="Permalink to this headline">¶</a></h3>
<p>The evolution of equation for pressure is obtained by taking the horizontal
divergence (i.e. <span class="math">\(\vec{\nabla}_H\cdot\)</span>)
of the Navier-Stokes equation. This operator is defined such
that</p>
<div class="math">
\[\vec{\nabla}_H\cdot\vec{a} = r\sin \dfrac{\partial (\sin\theta\,a_\theta)}{\partial \theta}
+r\sin \dfrac{\partial a_\phi}{\partial \phi}.\]</div>
<p>This relates to the total divergence via:</p>
<div class="math">
\[\vec{\nabla}\cdot\vec{a}= \dfrac{1}{r^2}\dfrac{\partial(r^2 a_r)}{\partial r}+
\vec{\nabla}_H\cdot\vec{a}.\]</div>
<p>The time-derivative term is thus expressed by</p>
<div class="math">
\[\begin{split}\begin{aligned}
\vec{\nabla}_H\cdot\left(\tilde{\rho}\dfrac{\partial \vec{u}}{\partial t}\right)
&amp;= \dfrac{\partial}{\partial t}\left[\vec{\nabla}_H\cdot(\tilde{\rho}\vec{u}
)\right] \\
&amp; =  \dfrac{\partial}{\partial t}\left[\vec{\nabla}\cdot(\tilde{\rho}\vec{u})
-\dfrac{1}{r^2}\dfrac{\partial(r^2\tilde{\rho} u_r)}{\partial r}\right] \\
&amp; = -\dfrac{\partial}{\partial t}\left[\dfrac{\partial (\tilde{\rho} u_r)}{\partial r}
+\dfrac{2\tilde{\rho} u_r}{r}\right] \\
&amp; = \dfrac{\partial}{\partial t}\left[\dfrac{\partial (\Delta_H W)}{\partial r}
+\dfrac{2}{r}\Delta_H W\right] \\
&amp; = \Delta_H\dfrac{\partial}{\partial t}\left(\dfrac{\partial W}{\partial r}\right)
\end{aligned}\end{split}\]</div>
<p>We note that the gravity term vanishes since <span class="math">\(\vec{\nabla}_H\cdot(\tilde{\rho}
g(r)\vec{e_r}) = 0\)</span>. Concerning the pressure gradient, one has</p>
<div class="math">
\[-\vec{\nabla}_H\cdot\left[\tilde{\rho} \vec{\nabla}\left(\dfrac{p'}{\tilde{\rho}}
\right)\right] = -\left\lbrace\vec{\nabla}\cdot\left[\tilde{\rho} \vec{\nabla}
\left(\dfrac{p'}{\tilde{\rho}}\right)\right]-
\dfrac{1}{r^2}\dfrac{\partial}{\partial r}\left[ r^2 \tilde{\rho}
\dfrac{\partial}{\partial r}\left(\dfrac{p'}{\tilde{\rho}}\right)\right] \right\rbrace =
-\Delta_H \, p'.\]</div>
<p>The viscosity term then reads</p>
<div class="math">
\[\begin{split}\begin{aligned}
\vec{\nabla}_H\cdot \left( \vec{\nabla}\cdot\mathsf{S} \right) = &amp; \nu\,\Delta_H\left[
\dfrac{\partial^3 W}{\partial r^3} + \left(\dfrac{d\ln\nu}{dr}-
\dfrac{d\ln\tilde{\rho}}{dr}\right) \dfrac{\partial^2 W}{\partial r^2} \right. \\
&amp; - \left[\dfrac{d^2\ln\tilde{\rho}}{dr^2} + \dfrac{d\ln\nu}{dr}\dfrac{d\ln\tilde{\rho}}{dr}+
\dfrac{2}{r}\left(\dfrac{d\ln\nu}{dr}+\dfrac{d\ln\tilde{\rho}}{dr}\right)
-\Delta_H \right]\dfrac{\partial W}{\partial r} \\
&amp; \left. -\left( \dfrac{2}{3}\dfrac{d\ln\tilde{\rho}}{dr}+\dfrac{2}{r}+\dfrac{d\ln\nu}{dr}
\right)\Delta_H\,W \right].
\end{aligned}\end{split}\]</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>Once again, this viscous term can be greatly simplified in the Boussinesq limit:</p>
<div class="last math">
\[\vec{\nabla}_H\cdot\left(\Delta \vec{u}\right) =
-\Delta_H\left[\dfrac{\partial^3 W}{\partial r^3}
+\Delta_H\,\dfrac{\partial W}{\partial r}-\dfrac{2}{r}\Delta_H\,W\right]\]</div>
</div>
<p>Using Eq. <a href="#equation-eqHorizLaplYlm">(8)</a> then allows to finally write the equation for the pressure
<span class="math">\(P_{\ell m n}\)</span>:</p>
<div class="math" id="equation-eqSpecP">
<span class="eqno">(18)</span>\[\begin{split}\boxed{
\begin{aligned}
E\,\dfrac{\ell(\ell+1)}{r^2}\left[
-\nu\,\left( \dfrac{2}{3}\dfrac{d\ln\tilde{\rho}}{dr}+\dfrac{2}{r}+\dfrac{d\ln\nu}{dr}
\right)\dfrac{\ell(\ell+1)}{r^2} \right.
&amp; \,{\cal C}_n  &amp; \\
\left\lbrace\dfrac{\partial}{\partial t} +
\nu\,\dfrac{\ell(\ell+1)}{r^2} + \nu\,\left[\dfrac{d^2\ln\tilde{\rho}}{dr^2}+
 \dfrac{d\ln\nu}{dr}\dfrac{d\ln\tilde{\rho}}{dr}+
\dfrac{2}{r}\left(\dfrac{d\ln\nu}{dr}+\dfrac{d\ln\tilde{\rho}}{dr}\right)\right]\right\rbrace
&amp; \,{\cal C}'_n  &amp; \\
-\nu\,\left(  \dfrac{d\ln\nu}{dr}-\dfrac{d\ln\tilde{\rho}}{dr}
\right) &amp;\,{\cal C}''_n &amp; \\
-\nu &amp; \,{\cal C}'''_n \left. \phantom{\dfrac{d\nu}{dr}}\right]&amp; W_{\ell m n} \\
+ \left[\dfrac{\ell(\ell+1)}{r^2}\right] &amp; \,{\cal C}_n &amp; P_{\ell m n} \\
= {\cal N}^P = -\int d\Omega\,{Y_{\ell}^{m}}^\star\,\vec{\nabla}_H\cdot\vec{F} &amp; &amp;
\end{aligned}}\end{split}\]</div>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<p class="last">The exact computation of the linear terms of <a href="#equation-eqSpecP">(18)</a> are coded in
the subroutines <a class="reference internal" href="apiFortran/timeAdvLinear.html#f/updatewp_mod/get_wpmat" title="f/updatewp_mod/get_wpmat"><code class="xref f f-subr docutils literal"><span class="pre">get_wpMat</span></code></a></p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>We note that the terms on the left hand side of <a href="#equation-eqSpecW">(16)</a>, <a href="#equation-eqSpecZ">(17)</a> and
<a href="#equation-eqSpecP">(18)</a> resulting from the viscous term, the pressure gradient,
the buoyancy term, and the explicit time derivative completely decouple
in spherical harmonic degree and order.</p>
<p>The terms that do not decouple, namely Coriolis force, Lorentz force and
advection of momentum, are collected on the right-hand side
of <a href="#equation-eqSpecW">(16)</a>, <a href="#equation-eqSpecZ">(17)</a> and <a href="#equation-eqSpecP">(18)</a> into the forcing term
<span class="math">\(\vec{F}\)</span>:</p>
<div class="last math" id="equation-eqForcing">
<span class="eqno">(19)</span>\[\vec{F}=-2\,\tilde{\rho}\,\vec{e_z}\times\vec{u} - E\,\tilde{\rho}\,
\vec{u}\cdot\vec{\nabla}\,\vec{u}
+\frac{1}{Pm}\left(\vec{\nabla}\times\vec{B}\right)\times\vec{B}\]</div>
</div>
<p>Resolving <span class="math">\(\vec{F}\)</span> into potential functions is not required. Its
numerical evaluation is discussed <a class="reference internal" href="#secnonlineareqs"><span>below</span></a>.</p>
</div>
<div class="section" id="equation-for-entropy">
<h3>Equation for entropy <span class="math">\(s\)</span><a class="headerlink" href="#equation-for-entropy" title="Permalink to this headline">¶</a></h3>
<p>The equation for the entropy (or temperature in the Boussinesq limit) is given by</p>
<div class="math" id="equation-eqSpecS">
<span class="eqno">(20)</span>\[\begin{split}\boxed{
\begin{aligned}
\dfrac{1}{Pr}\left[\left(Pr\dfrac{\partial}{\partial t} +
\kappa\,\dfrac{\ell(\ell+1)}{r^2}
\right)\right. &amp; \,{\cal C}_n  &amp; \\
-\kappa\,\left(\dfrac{d\ln\kappa}{dr}+\dfrac{d\ln\tilde{\rho}}{dr}+
+\dfrac{dln\tilde{T}}{dr}+\dfrac{2}{r}\right)
&amp;\,{\cal C}'_n &amp; \\
-\kappa &amp; \,{\cal C}''_n \left. \phantom{\dfrac{d\nu}{dr}}\right]&amp; s_{\ell m n} \\
= {\cal N}^S = -\int d\Omega\,{Y_{\ell}^{m}}^\star\,\left[\vec{u}\cdot\vec{\nabla}s+
\dfrac{Pr\,Di}{Ra}\dfrac{1}{\tilde{\rho}\tilde{T}}\left(\Phi_\nu+
\dfrac{\lambda}{Pm^2\,E}\,j^2\right) \right] &amp; &amp;
\end{aligned}}\end{split}\]</div>
<p>In this expression, <span class="math">\(j=\vec{\nabla}\times\vec{B}\)</span> is the current. Once again,
the numerical evaluation of the right-hand-side (i.e. the non-linear terms) is
discussed <a class="reference internal" href="#secnonlineareqs"><span>below</span></a>.</p>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<p class="last">The exact computation of the linear terms of <a href="#equation-eqSpecS">(20)</a> are coded in
the subroutines <a class="reference internal" href="apiFortran/timeAdvLinear.html#f/updates_mod/get_smat" title="f/updates_mod/get_smat"><code class="xref f f-subr docutils literal"><span class="pre">get_sMat</span></code></a></p>
</div>
</div>
<div class="section" id="equation-for-the-poloidal-magnetic-potential">
<h3>Equation for the poloidal magnetic potential <span class="math">\(g\)</span><a class="headerlink" href="#equation-for-the-poloidal-magnetic-potential" title="Permalink to this headline">¶</a></h3>
<p>The equation for the poloidal magnetic field coefficient reads</p>
<div class="math" id="equation-eqSpecG">
<span class="eqno">(21)</span>\[\begin{split}\boxed{
\begin{aligned}
\dfrac{\ell(\ell+1)}{r^2}\left[\left(\dfrac{\partial}{\partial t} +
\dfrac{1}{Pm}\lambda\,\dfrac{\ell(\ell+1)}{r^2}
\right)\right. &amp; \,{\cal C}_n  &amp; \\
-\dfrac{1}{Pm}\,\lambda &amp; \,{\cal C}''_n \left. \phantom{\dfrac{d\nu}{dr}}\right]&amp; g_{\ell m n} \\
= {\cal N}^g = \int d\Omega\,{Y_{\ell}^{m}}^\star\,\vec{e_r}\cdot \vec{D} &amp; &amp;
\end{aligned}}\end{split}\]</div>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<p class="last">The exact computation of the linear terms of <a href="#equation-eqSpecG">(21)</a> are coded in
the subroutines <a class="reference internal" href="apiFortran/timeAdvLinear.html#f/updateb_mod/get_bmat" title="f/updateb_mod/get_bmat"><code class="xref f f-subr docutils literal"><span class="pre">get_bMat</span></code></a></p>
</div>
</div>
<div class="section" id="equation-for-the-toroidal-magnetic-potential">
<h3>Equation for the toroidal magnetic potential <span class="math">\(h\)</span><a class="headerlink" href="#equation-for-the-toroidal-magnetic-potential" title="Permalink to this headline">¶</a></h3>
<p>The equation for the toroidal magnetic field coefficient reads</p>
<div class="math" id="equation-eqSpecH">
<span class="eqno">(22)</span>\[\begin{split}\boxed{
\begin{aligned}
\dfrac{\ell(\ell+1)}{r^2}\left[\left(\dfrac{\partial}{\partial t} +
\dfrac{1}{Pm}\lambda\,\dfrac{\ell(\ell+1)}{r^2}
\right)\right. &amp; \,{\cal C}_n  &amp; \\
-\dfrac{1}{Pm}\,\dfrac{d\lambda}{dr} &amp;\,{\cal C}'_n &amp; \\
-\dfrac{1}{Pm}\,\lambda &amp; \,{\cal C}''_n \left. \phantom{\dfrac{d\nu}{dr}}\right]&amp; h_{\ell m n} \\
= {\cal N}^h = \int d\Omega\,{Y_{\ell}^{m}}^\star\,\vec{e_r}\cdot \left(\vec{\nabla}\times \vec{D}\right) &amp; &amp;
\end{aligned}}\end{split}\]</div>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<p class="last">The exact computation of the linear terms of <a href="#equation-eqSpecH">(22)</a> are coded in
the subroutines <a class="reference internal" href="apiFortran/timeAdvLinear.html#f/updateb_mod/get_bmat" title="f/updateb_mod/get_bmat"><code class="xref f f-subr docutils literal"><span class="pre">get_bMat</span></code></a></p>
</div>
<p>We have now derived a full set of equations
<a href="#equation-eqSpecW">(16)</a>, <a href="#equation-eqSpecZ">(17)</a>, <a href="#equation-eqSpecP">(18)</a>, <a href="#equation-eqSpecS">(20)</a>, <a href="#equation-eqSpecG">(21)</a> and
<a href="#equation-eqSpecH">(22)</a>,
each describing the evolution of a single spherical harmonic mode of the
six unknown fields (assuming that the terms on the right hand side
are given). Each equation couples <span class="math">\(N+1\)</span> Chebyshev coefficients
for a given spherical harmonic mode <span class="math">\((\ell,m)\)</span>.
Typically, a collocation method is employed to solve for the Chebyshev coefficients.
This means that the equations are required to be exactly satisfied at <span class="math">\(N-1\)</span>
grid points defined by the equations <a href="#equation-eqChebMap">(14)</a> and <a href="#equation-eqChebGrid">(15)</a>.
Excluded are the points <span class="math">\(r=r_i\)</span> and <span class="math">\(r=r_o\)</span>, where the
<a class="reference internal" href="#secboundaryconditions"><span>boundary conditions</span></a> provide
additional constraints on the set of Chebyshev coefficients.</p>
</div>
</div>
<div class="section" id="time-stepping-schemes">
<h2>Time-stepping schemes<a class="headerlink" href="#time-stepping-schemes" title="Permalink to this headline">¶</a></h2>
<p>Implicit time stepping schemes theoretically offer increased stability and
allow for larger time steps.
However, fully implicit approaches have the disadvantage that
the nonlinear-terms couple all spherical harmonic modes.
The potential gain in computational speed is therefore lost at
higher resolution, where one very large matrix has to be dealt with
rather than a set of much smaller ones.
Similar considerations hold for the Coriolis force, one of
the dominating forces in the system and therefore a prime candidate for
implicit treatment. However, the Coriolis term couples modes <span class="math">\((\ell,m,n)\)</span> with
<span class="math">\((\ell+1,m,n)\)</span> and <span class="math">\((\ell-1,m,n)\)</span> and also couples poloidal and
toroidal flow potentials. An implicit treatment of the Coriolis term therefore
also results in a much larger (albeit sparse) inversion matrix.</p>
<p>W consequently adopt in <strong>MagIC</strong> a mixed implicit/explicit algorithm.
Nonlinear and Coriolis terms, collected on the right hand side of equations
<a href="#equation-eqSpecW">(16)</a>, <a href="#equation-eqSpecZ">(17)</a>, <a href="#equation-eqSpecP">(18)</a>, <a href="#equation-eqSpecS">(20)</a>, <a href="#equation-eqSpecG">(21)</a>
and <a href="#equation-eqSpecH">(22)</a> are treated explicitly with a second order
<a class="reference external" href="https://en.wikipedia.org/wiki/Linear_multistep_method">Adams-Bashforth</a> .
Terms collected on the left hand side are
time-stepped with an implicit modified <a class="reference external" href="https://en.wikipedia.org/wiki/Crank–Nicolson_method">Crank-Nicolson</a> algorithm.
While the equations are coupled radially, they decouple for all spherical
harmonic modes.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The poloidal flow potential <a href="#equation-eqSpecW">(16)</a> and the pressure <a href="#equation-eqSpecP">(18)</a>
are nevertheless coupled for a given spherical harmonic mode.</p>
</div>
<p>As an example, we derive the time stepping equation for the poloidal
magnetic potential of degree <span class="math">\(\ell\)</span> and order <span class="math">\(m\)</span>,
denoting the explicit nonlinear term at radial grid point <span class="math">\(r_k\)</span> with</p>
<div class="math">
\[D_{k\ell m}(t)= \int d\Omega\; {Y_{\ell}^{m}}^\star\; \vec{e_r} \cdot \vec{D}(t,r_k,\theta,\phi)\;\; .\]</div>
<p>After discretization of the partial time derivative,
<span class="math">\(\partial g_{\ell mn}/\partial t = [g_{\ell mn}(t+\delta t) - g_{\ell mn}(t)]/\delta t\)</span>
where <span class="math">\(\delta t\)</span> is the time step, we can formulate the left hand side
of <a href="#equation-eqSpecG">(21)</a> as a matrix multiplication. The matrices <span class="math">\(\mathsf{A}\)</span>  and
<span class="math">\(\mathsf{G}\)</span> are defined by</p>
<div class="math">
\[{A}_{kn} = \dfrac{\ell (\ell+1)}{r_k^2}\,\dfrac{1}{\delta t} {\cal C}_{nk}\;\;\]</div>
<p>and</p>
<div class="math">
\[{G}_{kn}=\dfrac{\ell(\ell+1)}{r_k^2}\,\dfrac{1}{Pm}\left( \dfrac{\ell(\ell+1}{r_k^2}
{\cal C}_{nk}-{\cal C}''_{nk} \right)\;\;,\]</div>
<p>where <span class="math">\({\cal C}_{nk}={\cal C}_n(r_k)\)</span>. The matrices depend on <span class="math">\(\ell\)</span>
but not on <span class="math">\(m\)</span>.  Advancing time from <span class="math">\(t\)</span> to <span class="math">\(t+\delta t\)</span> is
then a matter of solving</p>
<div class="math">
\[\left( {A}_{kn} + \alpha {G}_{kn}\right)\;g_{\ell mn}(t+\delta t) =
\left( {A}_{kn} - (1 - \alpha) {G}_{kn} \right)\;g_{\ell mn}(t) +
\frac{3}{2} D_{k\ell m}(t) - \frac{1}{2} D_{k\ell m}(t-\delta t)\;\;.\]</div>
<p>The classical Crank-Nicholson scheme is recovered for <span class="math">\(\alpha=0.5\)</span>, but
it seems that a slightly larger weight of <span class="math">\(\alpha=0.6\)</span> helps to stabilize
the time integration.  Since the stability requirements limiting <span class="math">\(\delta
t\)</span> will usually change during a computational run, the time step should be
adjusted accordingly.  The matrix <span class="math">\(\mathsf{G}\)</span> remains unchanged, but
<span class="math">\(\mathsf{A}\)</span> has to be updated whenever <span class="math">\(\delta t\)</span> is changed.
This, in turn, requires a new triangulation of matrix <span class="math">\(A_{kn}+\alpha G_{kn}\)</span>,
which is then stored for subsequent time steps until the next adjustment of
<span class="math">\(\delta t\)</span> is in order.</p>
<p><strong>Courant&#8217;s condition</strong> offers a guideline
concerning the value of <span class="math">\(\delta t\)</span>, demanding that <span class="math">\(\delta t\)</span> should be smaller
than the advection time between two grid points.  Strong Lorentz forces require
an additional stability criterion that is obtained by replacing the flow speed
by Alfvén&#8217;s velocity in a modified Courant criterion.
The explicit treatment of the Coriolis force requires that the time step is
limited to a fraction of the rotation period, which may be the relevant
criterion at low Ekman number when flow and magnetic field remain weak.
Non-homogeneous grids and other numerical effects generally require an
additional safety factor in the choice of <span class="math">\(\delta t\)</span>.</p>
</div>
<div class="section" id="coriolis-force-and-non-linear-terms">
<span id="secnonlineareqs"></span><h2>Coriolis force and non-linear terms<a class="headerlink" href="#coriolis-force-and-non-linear-terms" title="Permalink to this headline">¶</a></h2>
<div class="math" id="equation-eqAdvRadial">
<span class="eqno">(23)</span>\[{\cal A}_r=
-\tilde{\rho}\left(
u_r\dfrac{\partial u_r}{\partial r}+
\dfrac{u_\theta}{r}\dfrac{\partial u_r}{\partial \theta}+
\dfrac{u_\phi}{r\sin\theta}\dfrac{\partial u_r}{\partial \phi}
-\dfrac{u_\theta^2+u_\phi^2}{r}\right)+
\dfrac{1}{Pm}\left(j_\theta\,B_\phi-j_\phi\,B_\theta\right)\, ,\]</div>
<div class="math" id="equation-eqAdvTheta">
<span class="eqno">(24)</span>\[{\cal A}_\theta=
-\tilde{\rho}\left(
u_r\dfrac{\partial u_\theta}{\partial r}+
\dfrac{u_\theta}{r}\dfrac{\partial u_\theta}{\partial \theta} +
\dfrac{u_\phi}{r\sin\theta}\dfrac{\partial u_\theta}{\partial \phi}+
\dfrac{u_r u_\theta}{r}-\dfrac{\cos\theta}{r\sin\theta}u_\phi^2\right)+
\dfrac{1}{Pm}\left(j_\phi\,B_r-j_r\,B_\phi\right)\, ,\]</div>
<div class="math" id="equation-eqAdvPhi">
<span class="eqno">(25)</span>\[{\cal A}_\phi=
-\tilde{\rho}\left(
u_r\dfrac{\partial u_\phi}{\partial r}+
\dfrac{u_\theta}{r}\dfrac{\partial u_\phi}{\partial \theta} +
\dfrac{u_\phi}{r\sin\theta}\dfrac{\partial u_\phi}{\partial \phi}+
\dfrac{u_r u_\phi}{r} +\dfrac{\cos\theta}{r\sin\theta}u_\theta u_\phi\right)+
\dfrac{1}{Pm}\left(j_r\,B_\theta-j_\theta\,B_r\right)\, ,\]</div>
</div>
<div class="section" id="boundary-conditions-and-inner-core">
<span id="secboundaryconditions"></span><h2>Boundary conditions and inner core<a class="headerlink" href="#boundary-conditions-and-inner-core" title="Permalink to this headline">¶</a></h2>
<div class="section" id="mechanical-boundary-conditions">
<h3>Mechanical boundary conditions<a class="headerlink" href="#mechanical-boundary-conditions" title="Permalink to this headline">¶</a></h3>
<p>Since the system of equations is formulated on a radial grid, boundary
conditions can simply be satisfied by replacing the collocation equation
at grid points <span class="math">\(r_i\)</span> and <span class="math">\(r_o\)</span> with appropriate expressions.
The condition of zero radial flow on the boundaries implies</p>
<div class="math" id="equation-eqBcRigid1">
<span class="eqno">(26)</span>\[{\cal C}_n(r) W_{\ell mn} = 0 \;\;\mbox{at}\;\; r=r_i,r_o\;\;.\]</div>
<p>Note that the summation convention with respect to
radial modes <span class="math">\(n\)</span> is used again.
<strong>The no-slip</strong> condition further requires that the
horizontal flow components also have to vanish, provided
the two boundaries are at rest. This condition is fulfilled when</p>
<div class="math" id="equation-eqBcRigid2">
<span class="eqno">(27)</span>\[{\cal C}'_n(r) W_{\ell mn} = 0\;\;\mbox{at}\;\; r=r_i,r_o\]</div>
<p>and</p>
<div class="math" id="equation-eqBcRigid3">
<span class="eqno">(28)</span>\[{\cal C}_n(r) Z_{\ell mn} = 0\;\;\mbox{at}\;\; r=r_i,r_o\]</div>
<p>for all spherical harmonic modes <span class="math">\((\ell,m)\)</span>.
The conditions <a href="#equation-eqBcRigid1">(26)</a>-<a href="#equation-eqBcRigid3">(28)</a>
replace the poloidal flow potential equations <a href="#equation-eqSpecW">(16)</a>
and the pressure equation <a href="#equation-eqSpecP">(18)</a>, respectively, at
the collocation points <span class="math">\(r_i\)</span> and <span class="math">\(r_o\)</span>.</p>
<p>If the inner-core and/or the mantle are allowed to react to torques,
a condition based on the conservation of
angular momentum replaces condition <a href="#equation-eqBcRigid3">(28)</a> for the mode
<span class="math">\((\ell =1,m=0)\)</span>:</p>
<div class="math">
\[\mathsf{I} \dfrac{\partial\vec{\omega}}{\partial t}= \vec{\Gamma}\;\;.\]</div>
<p>The tensor <span class="math">\(\mathsf{I}\)</span> denotes the moment of inertia of inner core or mantle,
respectively, <span class="math">\(\vec{\omega}\)</span> is the mantle or inner-core rotation rate relative
to that of the reference frame, and <span class="math">\(\vec{\Gamma}\)</span> is the respective torque.</p>
<p><strong>Free-slip boundary conditions</strong> require that the viscous stress vanishes, which
in turn implies that the non-diagonal components <span class="math">\(\mathsf{Sr}_{r\phi}\)</span> and
<span class="math">\(\mathsf{S}_{r\theta}\)</span> of the rate-of-strain tensor vanish.
Translated to the spectral representation this requires</p>
<div class="math">
\[\left[{\cal C}''_n(r) -\left(\frac{2}{r}+\dfrac{d\ln\tilde{\rho}}{dr}\right)\,{\cal C}'_n(r)
\right] W_{\ell mn} = 0 \;\;\mbox{and}\;\;
\left[{\cal C}'_n(r) -\left(\frac{2}{r}+\dfrac{d\ln\tilde{\rho}}{dr}\right)\,{\cal C}_n(r)
\right] z_{\ell mn} = 0\;.\]</div>
</div>
<div class="section" id="magnetic-boundary-conditions-and-inner-core">
<h3>Magnetic boundary conditions and inner core<a class="headerlink" href="#magnetic-boundary-conditions-and-inner-core" title="Permalink to this headline">¶</a></h3>
<p>Magnetic boundary conditions at the interface with an insulating mantle
or insulating inner core are similarly implemented.
The toroidal magnetic field cannot enter any
insulator and therefore has to vanish at the boundary</p>
<div class="math">
\[{\cal C}_n(r) h_{\ell mn} = 0\;\;\mbox{at}\;\; r=r_i\;\;\mbox{and/or}\;\; r=r_o\;\;.\]</div>
<p>Matching conditions for the poloidal magnetic field with a source-free
external potential field require that the following equations are satisfied at
the boundary grid points:</p>
<div class="math">
\[{\cal C}_n^\prime(r) g_{\ell mn} - {\cal C}_n(r)\frac{\ell+1}{r} g_{\ell mn} = 0 \;\;\;\mbox{at}\;\;\; r=r_i,\]</div>
<div class="math">
\[{\cal C}_n^\prime(r) g_{\ell mn} + {\cal C}_n(r)\frac{\ell}{r} g_{\ell mn} = 0 \;\;\;\mbox{at}\;\;\; r=r_o.\]</div>
<p>If the inner core is modeled as an electrical conductor, a simplified dynamo
equation has to be solved in which the fluid flow is replaced by the
solid-body rotation of the inner core. The latter is described by a single toroidal
flow mode <span class="math">\((\ell=1,m=0)\)</span>. The resulting nonlinear terms can be expressed by a simple
spherical harmonic expansion, where the superscript <span class="math">\(I\)</span> denotes values in the
inner core and <span class="math">\(\omega_I\)</span> its differential rotation rate:</p>
<div class="math" id="equation-glmnI">
<span class="eqno">(29)</span>\[\int d\Omega\; {Y_{\ell}^{m}}^\star\;\vec{e_r}\cdot\left[\vec{\nabla}\times
\left(\vec{u^I}\times\vec{B^I}\right)\right] =
- i\,\omega_I\,m\,\dfrac{\ell(\ell+1)}{r^2}\;g_{\ell m}^I(r)\; ,\]</div>
<div class="math" id="equation-hlmnI">
<span class="eqno">(30)</span>\[\int d\Omega\; {Y_{\ell}^{m}}^\star\;\vec{e_r}\cdot\left[\vec{\nabla}\times
\vec{\nabla}\times\left(\vec{u^I}\times\vec{B^I}\right)\right] =
- i\,\omega_I\,m\,\dfrac{\ell(\ell+1)}{r^2} \;h_{\ell m}^I(r)\;\]</div>
<p>The expensive back and forth transformations between spherical
harmonic and grid representations are therefore not required for advancing the
inner-core magnetic field in time.</p>
<p>In the inner core the magnetic potentials are again conveniently
expanded into Chebyshev polynomials. The Chebyshev variable <span class="math">\(x\)</span>
spans the whole diameter of the inner core, so that grid points are dense
near the inner-core boundary but sparse in the center. The mapping is given by:</p>
<div class="math" id="equation-mapRIC">
<span class="eqno">(31)</span>\[x(r)=  \dfrac{r}{r_i}\;\;,\;\;-r_i\le r\le r_i\;\;.\]</div>
<p>Each point in the inner core is thus represented twice, by
grid points <span class="math">\(({r,\theta,\phi})\)</span> and <span class="math">\(({-r,\pi-\theta,\phi+\pi})\)</span>.
Since both representations must be identical, this imposes a symmetry
constraint that can be fulfilled when the radial expansion
comprises only polynomials of even order:</p>
<div class="math" id="equation-radI">
<span class="eqno">(32)</span>\[g_{\ell m}^I(r) = \left(\dfrac{r}{r_i}\right)^{\ell+1}
                  \,\sum_{i=0}^{M-1} g_{\ell m\,2i}^I\;{\cal C}_{2i}(r)\;\;.\]</div>
<p>An equivalent expression holds for the toroidal potential in the inner core.
FFTs can again by employed efficiently
for the radial transformation, using the <span class="math">\(M\)</span> extrema of
<span class="math">\({\cal C}_{2 M-1}(r)\)</span> with <span class="math">\(x&gt;0\)</span> as grid points.</p>
<p>The sets of spectral magnetic field equations for the inner and the outer core
are coupled via continuity equations for the magnetic field and the
horizontal electric field.
Continuity of the magnetic field is assured by (<strong>i</strong>) continuity of the
toroidal potential, (<strong>ii</strong>) continuity of the poloidal potential, and
(<strong>iii</strong>) continuity of the radial derivative of
the latter. Continuity of the horizontal electric field demands (<strong>iv</strong>) that
the radial derivative of the toroidal potential is continuous, provided
that the horizontal flow and the electrical conductivity are continuous
at the interface.
These four conditions replace the spectral equations
<a href="#equation-eqSpecG">(21)</a>, <a href="#equation-eqSpecH">(22)</a> on the outer-core side and
equations <a href="#equation-glmnI">(29)</a>, <a href="#equation-hlmnI">(30)</a> on the inner-core side.
Employing free-slip conditions or allowing for electrical conductivity differences
between inner and outer core leads to more complicated and even non-linear matching
conditions.</p>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="contents.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Numerical technique</a><ul>
<li><a class="reference internal" href="#poloidal-toroidal-decomposition">Poloidal/toroidal decomposition</a></li>
<li><a class="reference internal" href="#spherical-harmonic-representation">Spherical harmonic representation</a><ul>
<li><a class="reference internal" href="#special-relations">Special relations</a></li>
</ul>
</li>
<li><a class="reference internal" href="#radial-representation">Radial representation</a></li>
<li><a class="reference internal" href="#spectral-equations">Spectral equations</a><ul>
<li><a class="reference internal" href="#equation-for-the-poloidal-potential">Equation for the poloidal potential <span class="math">\(W\)</span></a></li>
<li><a class="reference internal" href="#equation-for-the-toroidal-potential">Equation for the toroidal potential <span class="math">\(Z\)</span></a></li>
<li><a class="reference internal" href="#equation-for-pressure">Equation for pressure <span class="math">\(P\)</span></a></li>
<li><a class="reference internal" href="#equation-for-entropy">Equation for entropy <span class="math">\(s\)</span></a></li>
<li><a class="reference internal" href="#equation-for-the-poloidal-magnetic-potential">Equation for the poloidal magnetic potential <span class="math">\(g\)</span></a></li>
<li><a class="reference internal" href="#equation-for-the-toroidal-magnetic-potential">Equation for the toroidal magnetic potential <span class="math">\(h\)</span></a></li>
</ul>
</li>
<li><a class="reference internal" href="#time-stepping-schemes">Time-stepping schemes</a></li>
<li><a class="reference internal" href="#coriolis-force-and-non-linear-terms">Coriolis force and non-linear terms</a></li>
<li><a class="reference internal" href="#boundary-conditions-and-inner-core">Boundary conditions and inner core</a><ul>
<li><a class="reference internal" href="#mechanical-boundary-conditions">Mechanical boundary conditions</a></li>
<li><a class="reference internal" href="#magnetic-boundary-conditions-and-inner-core">Magnetic boundary conditions and inner core</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="equations.html"
                        title="previous chapter">Formulation of the (magneto)-hydrodynamics problem</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="contribute.html"
                        title="next chapter">Contributing to the code</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/numerics.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="f-modindex.html" title="Fortran Module Index"
             >fortran modules</a> |</li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="contribute.html" title="Contributing to the code"
             >next</a> |</li>
        <li class="right" >
          <a href="equations.html" title="Formulation of the (magneto)-hydrodynamics problem"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="contents.html">Magic 5.1 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &copy; Copyright 2015, Thomas Gastine, Johannes Wicht, Ankit Barik, Lùcia Duarte.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.3.1.
    </div>
  </body>
</html>